<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #888888">/*</span>
<span style="color: #888888">Cervical Cancer Screening (CCS)</span>
<span style="color: #888888">*/</span>

library CCS_FHIR <span style="color: #008800; font-weight: bold">version</span> <span style="background-color: #fff0f0">&#39;1.0.1&#39;</span>

<span style="color: #333333">//</span><span style="color: #008800; font-weight: bold">using</span> FHIR <span style="color: #008800; font-weight: bold">version</span> <span style="background-color: #fff0f0">&#39;3.0.1&#39;</span>
<span style="color: #008800; font-weight: bold">using</span> FHIR <span style="color: #008800; font-weight: bold">version</span> <span style="background-color: #fff0f0">&#39;3.0.0&#39;</span>

<span style="color: #888888">/*</span>
<span style="color: #888888">Description</span>
<span style="color: #888888">The percentage of women 21-64 years of age who were screened for cervical</span>
<span style="color: #888888">		cancer using either of the following criteria:</span>
<span style="color: #888888">	* Women 21-64 years of age who had cervical cytology performed every 3 years.</span>
<span style="color: #888888">	* Women 30-64 years of age who had cervical cytology/human papillomavirus</span>
<span style="color: #888888">		(HPV) co-testing performed every 5 years.</span>
<span style="color: #888888">*/</span>

valueset <span style="color: #AA6600">&quot;Absence of Cervix Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1123.17&#39;</span> <span style="color: #333333">//</span> CPT
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Absence of Cervix Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1123.18&#39;</span> <span style="color: #333333">//</span> ICD10CM
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Absence of Cervix Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1123.19&#39;</span> <span style="color: #333333">//</span> ICD10PCS
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Absence of Cervix Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1123.20&#39;</span> <span style="color: #333333">//</span> ICD9CM
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Absence of Cervix Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1123.21&#39;</span> <span style="color: #333333">//</span> ICD9CMProc

valueset <span style="color: #AA6600">&quot;Cervical Cytology Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1208&#39;</span> <span style="color: #333333">//</span> <span style="color: #008800; font-weight: bold">Grouping</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Cervical Cytology Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1208.22&#39;</span> <span style="color: #333333">//</span> CPT
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Cervical Cytology Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1208.23&#39;</span> <span style="color: #333333">//</span> HCPCS
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Cervical Cytology Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1208.24&#39;</span> <span style="color: #333333">//</span> LOINC
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Cervical Cytology Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1208.25&#39;</span> <span style="color: #333333">//</span> RevCode

valueset <span style="color: #AA6600">&quot;HPV Tests Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1265.26&#39;</span> <span style="color: #333333">//</span> CPT
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;HPV Tests Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1265.27&#39;</span> <span style="color: #333333">//</span> HCPCS
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;HPV Tests Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.464.1004.1265.28&#39;</span> <span style="color: #333333">//</span> LOINC

<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Hospice Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;TODO&#39;</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Encounter Inpatient&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.666.5.307&#39;</span> <span style="color: #008800; font-weight: bold">version</span> <span style="background-color: #fff0f0">&#39;urn:hl7:version:eCQM%20Update%202017-05-05&#39;</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Discharged to Home for Hospice Care&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.117.1.7.1.209&#39;</span> <span style="color: #008800; font-weight: bold">version</span> <span style="background-color: #fff0f0">&#39;urn:hl7:version:eCQM%20Update%202017-05-05&#39;</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Discharged to Health Care Facility for Hospice Care&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113883.3.117.1.7.1.207&#39;</span> <span style="color: #008800; font-weight: bold">version</span> <span style="background-color: #fff0f0">&#39;urn:hl7:version:eCQM%20Update%202017-05-05&#39;</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;Hospice care ambulatory&quot;</span>: <span style="background-color: #fff0f0">&#39;2.16.840.1.113762.1.4.1108.15&#39;</span> <span style="color: #008800; font-weight: bold">version</span> <span style="background-color: #fff0f0">&#39;urn:hl7:version:eCQM%20Update%202017-05-05&#39;</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;X Commercial Coverage Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;TODO&#39;</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;X Medicaid Coverage Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;TODO&#39;</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;X Medicare Coverage Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;TODO&#39;</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;X Institutional SNP Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;TODO&#39;</span>
<span style="color: #333333">//</span> valueset <span style="color: #AA6600">&quot;X Long-Term in Institution Value Set&quot;</span>: <span style="background-color: #fff0f0">&#39;TODO&#39;</span>

<span style="color: #888888">/*</span>
<span style="color: #888888">This library has an explicit parameter which is the product line.</span>
<span style="color: #888888">Recognized normal arguments are {&#39;commercial&#39;, &#39;medicaid&#39;, &#39;medicare&#39;}.</span>
<span style="color: #888888">If one of these normal arguments is given, the patient will only be</span>
<span style="color: #888888">considered to be in the Initial Population if they have an appropriate</span>
<span style="color: #888888">continuous enrollment in that kind of medical plan.</span>
<span style="color: #888888">If instead a null argument is given, their enrollment status will have no</span>
<span style="color: #888888">effect on whether they are considered to be in the Initial Population.</span>
<span style="color: #888888">If instead some other argument is given (an unrecognized plan type),</span>
<span style="color: #888888">the patient will unconditionally NOT be in the Initial Population.</span>
<span style="color: #888888">*/</span>

<span style="color: #008800; font-weight: bold">parameter</span> <span style="color: #AA6600">&quot;Product Line&quot;</span> String

<span style="color: #888888">/*</span>
<span style="color: #888888">This library has an explicit parameter which is the measurement year.</span>
<span style="color: #888888">While the actual parameter&#39;s type accepts all intervals, this library</span>
<span style="color: #888888">expects it will only be given arguments corresponding exactly to one whole</span>
<span style="color: #888888">calendar year, and it will not behave properly otherwise; 2017 for example:</span>
<span style="color: #888888">Interval[DateTime(2017,1,1,0,0,0,0), DateTime(2018,1,1,0,0,0,0))</span>
<span style="color: #888888">*/</span>

<span style="color: #008800; font-weight: bold">parameter</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span> <span style="color: #007020">Interval</span><span style="color: #333333">&lt;</span>DateTime<span style="color: #333333">&gt;</span>

define <span style="color: #AA6600">&quot;First Predecessor Year&quot;</span>:
	<span style="color: #007020">Interval</span>[<span style="color: #008800; font-weight: bold">start</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span> <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #008800; font-weight: bold">year</span>, <span style="color: #008800; font-weight: bold">end</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span> <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #008800; font-weight: bold">year</span>)

define <span style="color: #AA6600">&quot;Second Predecessor Year&quot;</span>:
	<span style="color: #007020">Interval</span>[<span style="color: #008800; font-weight: bold">start</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span> <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">2</span> years, <span style="color: #008800; font-weight: bold">end</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span> <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #008800; font-weight: bold">year</span>)

define <span style="color: #AA6600">&quot;Third Predecessor Quarter&quot;</span>:
	<span style="color: #007020">Interval</span>[<span style="color: #008800; font-weight: bold">start</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span> <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">2</span> years <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">3</span> months, <span style="color: #008800; font-weight: bold">end</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span> <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">3</span> years)

define <span style="color: #AA6600">&quot;Lookback Interval Two More Years&quot;</span>:
	<span style="color: #007020">Interval</span>[<span style="color: #008800; font-weight: bold">start</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span> <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">2</span> years, <span style="color: #008800; font-weight: bold">end</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span>)

define <span style="color: #AA6600">&quot;Lookback Interval Four More Years&quot;</span>:
	<span style="color: #007020">Interval</span>[<span style="color: #008800; font-weight: bold">start</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span> <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">4</span> years, <span style="color: #008800; font-weight: bold">end</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span>)

<span style="color: #888888">/*</span>
<span style="color: #888888">This library evaluates with respect to exactly 1 candidate patient at a time,</span>
<span style="color: #888888">that patient being given by the special context parameter Patient.</span>
<span style="color: #888888">*/</span>

context Patient

<span style="color: #888888">/*</span>
<span style="color: #888888">Initial Population</span>
<span style="color: #888888">Product lines -- Commercial, Medicaid, Medicare (report each product line separately).</span>
<span style="color: #888888">*/</span>

define <span style="color: #AA6600">&quot;Initial Population&quot;</span>:
	<span style="color: #AA6600">&quot;Is Female&quot;</span>
		<span style="color: #008800; font-weight: bold">and</span> <span style="color: #AA6600">&quot;Is Age 24 to 64 at End&quot;</span>
<span style="color: #888888">/*</span>
<span style="color: #888888">		and (not &quot;Is In Hospice&quot;)</span>
<span style="color: #888888">		and &quot;Is In Applicable Product Line&quot;</span>
<span style="color: #888888">*/</span>

define <span style="color: #AA6600">&quot;Is Female&quot;</span>:
	Patient.gender.value <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;female&#39;</span>

define <span style="color: #AA6600">&quot;Is Age 24 to 64 at End&quot;</span>:
	CalendarAgeInYearsAt(Patient.birthDate.value, <span style="color: #008800; font-weight: bold">end</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span>) <span style="color: #008800; font-weight: bold">between</span> <span style="color: #0000DD; font-weight: bold">24</span> <span style="color: #008800; font-weight: bold">and</span> <span style="color: #0000DD; font-weight: bold">64</span>

<span style="color: #888888">/*</span>
<span style="color: #888888">define &quot;Is In Hospice&quot;:</span>
<span style="color: #888888">	exists(</span>
<span style="color: #888888">		[Encounter: &quot;Hospice Value Set&quot;] Enc</span>
<span style="color: #888888">			where Enc.status.value in { &#39;planned&#39;, &#39;arrived&#39;, &#39;triaged&#39;, &#39;in-progress&#39;, &#39;onleave&#39;, &#39;finished&#39; }</span>
<span style="color: #888888">				and PeriodToIntervalOfDT(Enc.period) overlaps day of &quot;Measurement Period&quot;</span>
<span style="color: #888888">	)</span>
<span style="color: #888888">	or</span>
<span style="color: #888888">	exists(</span>
<span style="color: #888888">		[Encounter: &quot;Encounter Inpatient&quot;] DischargeHospice</span>
<span style="color: #888888">			where DischargeHospice.status.value in { &#39;planned&#39;, &#39;arrived&#39;, &#39;triaged&#39;, &#39;in-progress&#39;, &#39;onleave&#39;, &#39;finished&#39; }</span>
<span style="color: #888888">				and (CodingToCode(DischargeHospice.hospitalization.dischargeDisposition.coding)</span>
<span style="color: #888888">						in &quot;Discharged to Home for Hospice Care&quot;</span>
<span style="color: #888888">					or CodingToCode(DischargeHospice.hospitalization.dischargeDisposition.coding)</span>
<span style="color: #888888">						in &quot;Discharged to Health Care Facility for Hospice Care&quot;)</span>
<span style="color: #888888">				and PeriodToIntervalOfDT(DischargeHospice.period) ends during day of &quot;Measurement Period&quot;</span>
<span style="color: #888888">	)</span>
<span style="color: #888888">	or</span>
<span style="color: #888888">	exists(</span>
<span style="color: #888888">		[ProcedureRequest: &quot;Hospice care ambulatory&quot;] HospiceOrder</span>
<span style="color: #888888">			where HospiceOrder.status.value in { &#39;active&#39;, &#39;completed&#39; }</span>
<span style="color: #888888">				and HospiceOrder.authoredOn.value during day of &quot;Measurement Period&quot;</span>
<span style="color: #888888">	)</span>
<span style="color: #888888">	or</span>
<span style="color: #888888">	exists(</span>
<span style="color: #888888">		[Procedure: &quot;Hospice care ambulatory&quot;] HospicePerformed</span>
<span style="color: #888888">			where HospicePerformed.status.value in { &#39;preparation&#39;, &#39;in-progress&#39;, &#39;suspended&#39;, &#39;aborted&#39;, &#39;completed&#39; }</span>
<span style="color: #888888">				and PeriodToIntervalOfDT(HospicePerformed.performed) overlaps day of &quot;Measurement Period&quot;</span>
<span style="color: #888888">	)</span>

<span style="color: #888888">define &quot;Is In Applicable Product Line&quot;:</span>
<span style="color: #888888">	case</span>
<span style="color: #888888">		when (&quot;Product Line&quot; ~ null) then true</span>
<span style="color: #888888">		when (&quot;Product Line&quot; = &#39;commercial&#39;) then &quot;Is Continuous Enrollment&quot;</span>
<span style="color: #888888">		when (&quot;Product Line&quot; = &#39;medicaid&#39;) then &quot;Is Continuous Enrollment&quot;</span>
<span style="color: #888888">		when (&quot;Product Line&quot; = &#39;medicare&#39;) then</span>
<span style="color: #888888">			(&quot;Is Continuous Enrollment&quot;</span>
<span style="color: #888888">				and (if &quot;Is Age 65 Plus at Start&quot;</span>
<span style="color: #888888">					then (&quot;Is Enrolled in Institutional SNP&quot;</span>
<span style="color: #888888">						or &quot;Is Living Long-Term in Institution&quot;)</span>
<span style="color: #888888">					else false))</span>
<span style="color: #888888">		else false</span>
<span style="color: #888888">	end</span>

<span style="color: #888888">define &quot;Enrollment Periods&quot;:</span>
<span style="color: #888888">	collapse(</span>
<span style="color: #888888">		[Coverage] Cov</span>
<span style="color: #888888">			where Cov.status.value in { &#39;active&#39;, &#39;cancelled&#39; }</span>
<span style="color: #888888">				and case &quot;Product Line&quot;</span>
<span style="color: #888888">					when &#39;commercial&#39; then</span>
<span style="color: #888888">						CodingToCode(Cov.type.coding) in &quot;X Commercial Coverage Value Set&quot;</span>
<span style="color: #888888">					when &#39;medicaid&#39; then</span>
<span style="color: #888888">						CodingToCode(Cov.type.coding) in &quot;X Medicaid Coverage Value Set&quot;</span>
<span style="color: #888888">					when &#39;medicare&#39; then</span>
<span style="color: #888888">						CodingToCode(Cov.type.coding) in &quot;X Medicare Coverage Value Set&quot;</span>
<span style="color: #888888">					else false</span>
<span style="color: #888888">				end</span>
<span style="color: #888888">			return PeriodToIntervalOfDT(Cov.period)</span>
<span style="color: #888888">	)</span>
<span style="color: #888888">	// We assume [Coverage] in Patient context implicitly has this filter:</span>
<span style="color: #888888">	// Cov.beneficiary.identifier ~ Patient.identifier</span>
<span style="color: #888888">	// ... and that the paitient is not connected as a policy holder or payor.</span>
<span style="color: #888888">	// TODO: Properly determine organization(s) for the product line.</span>
<span style="color: #888888">	// Note: collapse() also puts the resulting intervals in order.</span>

<span style="color: #888888">define function &quot;Enrollment Periods In Year&quot;(Year Interval&lt;DateTime&gt;):</span>
<span style="color: #888888">	&quot;Enrollment Periods&quot; EnrP</span>
<span style="color: #888888">		where EnrP overlaps day of Year</span>
<span style="color: #888888">		return EnrP intersect Year</span>

<span style="color: #888888">define function &quot;Is Continuous Enrollment In Year&quot;(Year Interval&lt;DateTime&gt;):</span>
<span style="color: #888888">	case Count(&quot;Enrollment Periods In Year&quot;(Year))</span>
<span style="color: #888888">		when 1 then (</span>
<span style="color: #888888">			((&quot;Enrollment Periods In Year&quot;(Year)[0] starts Year)</span>
<span style="color: #888888">				and ((difference in days between</span>
<span style="color: #888888">						end of &quot;Enrollment Periods In Year&quot;(Year)[0]</span>
<span style="color: #888888">						and end of Year</span>
<span style="color: #888888">					) &lt;= 45))</span>
<span style="color: #888888">			or</span>
<span style="color: #888888">			((&quot;Enrollment Periods In Year&quot;(Year)[0] ends Year)</span>
<span style="color: #888888">				and ((difference in days between</span>
<span style="color: #888888">						start of &quot;Enrollment Periods In Year&quot;(Year)[0]</span>
<span style="color: #888888">						and start of Year</span>
<span style="color: #888888">					) &lt;= 45))</span>
<span style="color: #888888">		)</span>
<span style="color: #888888">		when 2 then (</span>
<span style="color: #888888">			(&quot;Enrollment Periods In Year&quot;(Year)[0] starts Year)</span>
<span style="color: #888888">				and (&quot;Enrollment Periods In Year&quot;(Year)[1] ends Year)</span>
<span style="color: #888888">				and ((difference in days between</span>
<span style="color: #888888">						end of &quot;Enrollment Periods In Year&quot;(Year)[0]</span>
<span style="color: #888888">						and start of &quot;Enrollment Periods In Year&quot;(Year)[1]</span>
<span style="color: #888888">					) &lt;= 45)</span>
<span style="color: #888888">		)</span>
<span style="color: #888888">		else false</span>
<span style="color: #888888">	end</span>

<span style="color: #888888">define function &quot;Is Continuous Enrollment In Quarter&quot;(Quarter Interval&lt;DateTime&gt;):</span>
<span style="color: #888888">	case Count(&quot;Enrollment Periods In Year&quot;(Quarter))</span>
<span style="color: #888888">		when 1 then (&quot;Enrollment Periods In Year&quot;(Quarter)[0] = Quarter)</span>
<span style="color: #888888">		else false</span>
<span style="color: #888888">	end</span>

<span style="color: #888888">define &quot;Is Continuous Enrollment&quot;:</span>
<span style="color: #888888">	&quot;Is Continuous Enrollment In Year&quot;(&quot;Measurement Period&quot;)</span>
<span style="color: #888888">		and &quot;Is Continuous Enrollment In Year&quot;(&quot;First Predecessor Year&quot;)</span>
<span style="color: #888888">		and &quot;Is Continuous Enrollment In Year&quot;(&quot;Second Predecessor Year&quot;)</span>
<span style="color: #888888">		and &quot;Is Continuous Enrollment In Quarter&quot;(&quot;Third Predecessor Quarter&quot;)</span>

<span style="color: #888888">define &quot;Is Age 65 Plus at Start&quot;:</span>
<span style="color: #888888">	CalendarAgeInYearsAt(Patient.birthDate.value, start of &quot;Measurement Period&quot;) &gt;= 65</span>

<span style="color: #888888">define &quot;Is Enrolled in Institutional SNP&quot;:</span>
<span style="color: #888888">	exists(</span>
<span style="color: #888888">		[Encounter: &quot;X Institutional SNP Value Set&quot;] Enc</span>
<span style="color: #888888">			where Enc.status.value in { &#39;planned&#39;, &#39;arrived&#39;, &#39;triaged&#39;, &#39;in-progress&#39;, &#39;onleave&#39;, &#39;finished&#39; }</span>
<span style="color: #888888">				and PeriodToIntervalOfDT(Enc.period) overlaps day of &quot;Measurement Period&quot;</span>
<span style="color: #888888">	)</span>
<span style="color: #888888">	// TODO: Determine properly whether the patient was in SNP during the measurement year.</span>

<span style="color: #888888">define &quot;Is Living Long-Term in Institution&quot;:</span>
<span style="color: #888888">	exists(</span>
<span style="color: #888888">		[Encounter: &quot;X Long-Term in Institution Value Set&quot;] Enc</span>
<span style="color: #888888">			where Enc.status.value in { &#39;planned&#39;, &#39;arrived&#39;, &#39;triaged&#39;, &#39;in-progress&#39;, &#39;onleave&#39;, &#39;finished&#39; }</span>
<span style="color: #888888">				and PeriodToIntervalOfDT(Enc.period) overlaps day of &quot;Measurement Period&quot;</span>
<span style="color: #888888">	)</span>
<span style="color: #888888">	// TODO: Determine properly whether the patient was in LTI during the measurement year.</span>
<span style="color: #888888">*/</span>

<span style="color: #888888">/*</span>
<span style="color: #888888">Administrative Specification</span>
<span style="color: #888888">*/</span>

define <span style="color: #AA6600">&quot;Denominator&quot;</span>:
	<span style="color: #333333">//</span> was <span style="color: #AA6600">&quot;Initial Population&quot;</span>, but that will always be <span style="color: #008800; font-weight: bold">true</span> if this expression <span style="color: #008800; font-weight: bold">is</span> executed
    <span style="color: #008800; font-weight: bold">true</span>

define <span style="color: #AA6600">&quot;Numerator&quot;</span>:
	<span style="color: #008800; font-weight: bold">case</span>
		<span style="color: #008800; font-weight: bold">when</span> <span style="color: #AA6600">&quot;Is Cervical Cytology Test In Last 3 Years&quot;</span> <span style="color: #008800; font-weight: bold">then</span> <span style="color: #008800; font-weight: bold">true</span>
		<span style="color: #008800; font-weight: bold">when</span> (<span style="color: #008800; font-weight: bold">not</span> <span style="color: #AA6600">&quot;Is Age 30 to 64 at End&quot;</span>) <span style="color: #008800; font-weight: bold">then</span> <span style="color: #008800; font-weight: bold">false</span>
		<span style="color: #008800; font-weight: bold">when</span> <span style="color: #AA6600">&quot;Is Cervical Cytology Plus HPV Test In Last 5 Years&quot;</span> <span style="color: #008800; font-weight: bold">then</span> <span style="color: #008800; font-weight: bold">true</span>
		<span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">false</span>
	<span style="color: #008800; font-weight: bold">end</span>

define <span style="color: #AA6600">&quot;Is Age 30 to 64 at End&quot;</span>:
	CalendarAgeInYearsAt(Patient.birthDate.value, <span style="color: #008800; font-weight: bold">end</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span>) <span style="color: #008800; font-weight: bold">between</span> <span style="color: #0000DD; font-weight: bold">30</span> <span style="color: #008800; font-weight: bold">and</span> <span style="color: #0000DD; font-weight: bold">64</span>

define <span style="color: #AA6600">&quot;Is Cervical Cytology Test In Last 3 Years&quot;</span>:
	<span style="color: #008800; font-weight: bold">exists</span>(
		<span style="color: #AA6600">&quot;Dates of Cervical Cytology Tests&quot;</span> WhenCC
			<span style="color: #008800; font-weight: bold">where</span> WhenCC included <span style="color: #008800; font-weight: bold">in</span> <span style="color: #008800; font-weight: bold">day</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Lookback Interval Two More Years&quot;</span>
	)

define <span style="color: #AA6600">&quot;Is Cervical Cytology Plus HPV Test In Last 5 Years&quot;</span>:
	<span style="color: #008800; font-weight: bold">exists</span>(
		<span style="color: #AA6600">&quot;Dates of Cervical Cytology Tests&quot;</span> WhenCC
			<span style="color: #008800; font-weight: bold">with</span> <span style="color: #AA6600">&quot;Dates of HPV Tests&quot;</span> WhenHPV
				such that (((difference <span style="color: #008800; font-weight: bold">in</span> days <span style="color: #008800; font-weight: bold">between</span> <span style="color: #008800; font-weight: bold">start</span> <span style="color: #008800; font-weight: bold">of</span> WhenCC <span style="color: #008800; font-weight: bold">and</span> <span style="color: #008800; font-weight: bold">start</span> <span style="color: #008800; font-weight: bold">of</span> WhenHPV) <span style="color: #333333">&lt;=</span> <span style="color: #0000DD; font-weight: bold">4</span>)
					<span style="color: #008800; font-weight: bold">and</span> CalendarAgeInYearsAt(Patient.birthDate.value, <span style="color: #008800; font-weight: bold">start</span> <span style="color: #008800; font-weight: bold">of</span> WhenCC) <span style="color: #333333">&gt;=</span> <span style="color: #0000DD; font-weight: bold">30</span>
					<span style="color: #008800; font-weight: bold">and</span> CalendarAgeInYearsAt(Patient.birthDate.value, <span style="color: #008800; font-weight: bold">start</span> <span style="color: #008800; font-weight: bold">of</span> WhenHPV) <span style="color: #333333">&gt;=</span> <span style="color: #0000DD; font-weight: bold">30</span>
					<span style="color: #008800; font-weight: bold">and</span> WhenCC included <span style="color: #008800; font-weight: bold">in</span> <span style="color: #008800; font-weight: bold">day</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Lookback Interval Four More Years&quot;</span>
					<span style="color: #008800; font-weight: bold">and</span> WhenHPV included <span style="color: #008800; font-weight: bold">in</span> <span style="color: #008800; font-weight: bold">day</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Lookback Interval Four More Years&quot;</span>)
	)

define <span style="color: #AA6600">&quot;Dates of Cervical Cytology Tests&quot;</span>:
	([<span style="color: #008800; font-weight: bold">Procedure</span>: <span style="color: #AA6600">&quot;Cervical Cytology Value Set&quot;</span>] Proc
		<span style="color: #008800; font-weight: bold">where</span> Proc.status.value <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;completed&#39;</span>
		<span style="color: #008800; font-weight: bold">return</span> PeriodToIntervalOfDT(Proc.performed))
	<span style="color: #008800; font-weight: bold">union</span>
	([DiagnosticReport: <span style="color: #AA6600">&quot;Cervical Cytology Value Set&quot;</span>] DiagRep
		<span style="color: #008800; font-weight: bold">where</span> DiagRep.status.value <span style="color: #008800; font-weight: bold">in</span> <span style="color: #FF0000; background-color: #FFAAAA">{</span> <span style="background-color: #fff0f0">&#39;preliminary&#39;</span>, <span style="background-color: #fff0f0">&#39;final&#39;</span>, <span style="background-color: #fff0f0">&#39;amended&#39;</span>, <span style="background-color: #fff0f0">&#39;corrected&#39;</span>, <span style="background-color: #fff0f0">&#39;appended&#39;</span> <span style="color: #FF0000; background-color: #FFAAAA">}</span>
		<span style="color: #008800; font-weight: bold">return</span> PeriodToIntervalOfDT(DiagRep.effective))
	<span style="color: #008800; font-weight: bold">union</span>
	([Observation: <span style="color: #AA6600">&quot;Cervical Cytology Value Set&quot;</span>] Obs
		<span style="color: #008800; font-weight: bold">where</span> Obs.status.value <span style="color: #008800; font-weight: bold">in</span> <span style="color: #FF0000; background-color: #FFAAAA">{</span> <span style="background-color: #fff0f0">&#39;final&#39;</span>, <span style="background-color: #fff0f0">&#39;amended&#39;</span> <span style="color: #FF0000; background-color: #FFAAAA">}</span>
		<span style="color: #008800; font-weight: bold">return</span> DateTimeToInterval(Obs.effective))

define <span style="color: #AA6600">&quot;Dates of HPV Tests&quot;</span>:
	([<span style="color: #008800; font-weight: bold">Procedure</span>: <span style="color: #AA6600">&quot;HPV Tests Value Set&quot;</span>] Proc
		<span style="color: #008800; font-weight: bold">where</span> Proc.status.value <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;completed&#39;</span>
		<span style="color: #008800; font-weight: bold">return</span> PeriodToIntervalOfDT(Proc.performed))
	<span style="color: #008800; font-weight: bold">union</span>
	([DiagnosticReport: <span style="color: #AA6600">&quot;HPV Tests Value Set&quot;</span>] DiagRep
		<span style="color: #008800; font-weight: bold">where</span> DiagRep.status.value <span style="color: #008800; font-weight: bold">in</span> <span style="color: #FF0000; background-color: #FFAAAA">{</span> <span style="background-color: #fff0f0">&#39;preliminary&#39;</span>, <span style="background-color: #fff0f0">&#39;final&#39;</span>, <span style="background-color: #fff0f0">&#39;amended&#39;</span>, <span style="background-color: #fff0f0">&#39;corrected&#39;</span>, <span style="background-color: #fff0f0">&#39;appended&#39;</span> <span style="color: #FF0000; background-color: #FFAAAA">}</span>
		<span style="color: #008800; font-weight: bold">return</span> PeriodToIntervalOfDT(DiagRep.effective))
	<span style="color: #008800; font-weight: bold">union</span>
	([Observation: <span style="color: #AA6600">&quot;HPV Tests Value Set&quot;</span>] Obs
		<span style="color: #008800; font-weight: bold">where</span> Obs.status.value <span style="color: #008800; font-weight: bold">in</span> <span style="color: #FF0000; background-color: #FFAAAA">{</span> <span style="background-color: #fff0f0">&#39;final&#39;</span>, <span style="background-color: #fff0f0">&#39;amended&#39;</span> <span style="color: #FF0000; background-color: #FFAAAA">}</span>
		<span style="color: #008800; font-weight: bold">return</span> DateTimeToInterval(Obs.effective))

define <span style="color: #AA6600">&quot;Denominator Exclusion&quot;</span>:
	<span style="color: #AA6600">&quot;Is Hysterectomy&quot;</span>

define <span style="color: #AA6600">&quot;Is Hysterectomy&quot;</span>:
	<span style="color: #008800; font-weight: bold">exists</span>(
		[<span style="color: #008800; font-weight: bold">Procedure</span>: <span style="color: #AA6600">&quot;Absence of Cervix Value Set&quot;</span>] Proc
			<span style="color: #008800; font-weight: bold">where</span> Proc.status.value <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;completed&#39;</span>
				<span style="color: #008800; font-weight: bold">and</span> <span style="color: #008800; font-weight: bold">end</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #008800; font-weight: bold">case</span> <span style="color: #008800; font-weight: bold">when</span> Proc.performed <span style="color: #008800; font-weight: bold">is</span> DateTime <span style="color: #008800; font-weight: bold">then</span> <span style="color: #007020">Interval</span>[Proc.performed.value, Proc.performed.value] <span style="color: #008800; font-weight: bold">else</span> <span style="color: #007020">Interval</span>[Proc.performed.<span style="color: #AA6600">&quot;start&quot;</span>.value, Proc.performed.<span style="color: #AA6600">&quot;end&quot;</span>.value] <span style="color: #008800; font-weight: bold">end</span> same <span style="color: #008800; font-weight: bold">day</span> <span style="color: #008800; font-weight: bold">or</span> <span style="color: #008800; font-weight: bold">before</span> <span style="color: #008800; font-weight: bold">end</span> <span style="color: #008800; font-weight: bold">of</span> <span style="color: #AA6600">&quot;Measurement Period&quot;</span>
	)

<span style="color: #888888">/*</span>
<span style="color: #888888">Hybrid Specification</span>
<span style="color: #888888">TODO, if needed</span>
<span style="color: #888888">*/</span>


<span style="color: #888888">/*</span>
<span style="color: #888888">Utility Functions</span>
<span style="color: #888888">*/</span>

define <span style="color: #008800; font-weight: bold">function</span> DateTimeToInterval(<span style="color: #007020">date</span> FHIR.dateTime):
	<span style="color: #007020">Interval</span>[<span style="color: #007020">date</span>.value, <span style="color: #007020">date</span>.value]

define <span style="color: #008800; font-weight: bold">function</span> PeriodToIntervalOfDT(value FHIR.Period):
	<span style="color: #007020">Interval</span>[value.<span style="color: #AA6600">&quot;start&quot;</span>.value, value.<span style="color: #AA6600">&quot;end&quot;</span>.value]

define <span style="color: #008800; font-weight: bold">function</span> CodingToCode(coding FHIR.Coding):
	<span style="color: #008800; font-weight: bold">System</span>.Code <span style="color: #FF0000; background-color: #FFAAAA">{</span>
		code: coding.code.value,
		<span style="color: #008800; font-weight: bold">system</span>: coding.<span style="color: #008800; font-weight: bold">system</span>.value,
		<span style="color: #008800; font-weight: bold">version</span>: coding.<span style="color: #008800; font-weight: bold">version</span>.value,
		display: coding.display.value
	<span style="color: #FF0000; background-color: #FFAAAA">}</span>
	<span style="color: #333333">//</span> <span style="color: #008800; font-weight: bold">From</span> FHIRHelpers

define <span style="color: #008800; font-weight: bold">function</span> <span style="color: #AA6600">&quot;ToDate&quot;</span>(Value DateTime ):
	DateTime(<span style="color: #008800; font-weight: bold">year</span> <span style="color: #008800; font-weight: bold">from</span> Value, <span style="color: #008800; font-weight: bold">month</span> <span style="color: #008800; font-weight: bold">from</span> Value, <span style="color: #008800; font-weight: bold">day</span> <span style="color: #008800; font-weight: bold">from</span> Value, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, timezone <span style="color: #008800; font-weight: bold">from</span> Value)

define <span style="color: #008800; font-weight: bold">function</span> CalendarAgeInYearsAt(BirthDateTime DateTime, AsOf DateTime):
    years <span style="color: #008800; font-weight: bold">between</span> ToDate(BirthDateTime)<span style="color: #008800; font-weight: bold">and</span> ToDate(AsOf)
</pre></div>
